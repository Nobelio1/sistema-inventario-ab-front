<div class="fixed inset-0 bg-black opacity-50 z-50" (click)="close()"></div>

<div class="fixed inset-0 flex items-center justify-center z-50 p-4 pointer-events-none">
  <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto pointer-events-auto">
    <div class="bg-sky-900 text-white px-6 py-4 flex justify-between items-center sticky top-0 z-10">
      <h2 class="text-xl font-bold">
        {{ producto ? 'Editar Producto' : 'Nuevo Producto' }}
      </h2>
      <button (click)="close()" class="text-white hover:text-gray-200 transition-colors">
        <lucide-angular [img]="closeIcon" class="w-6 h-6"></lucide-angular>
      </button>
    </div>

    <form [formGroup]="productoForm" (ngSubmit)="onSubmit()" class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Código -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Código <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            formControlName="codigo"
            placeholder="Ej: P001"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('codigo')?.invalid && productoForm.get('codigo')?.touched"
          />
          @if (productoForm.get('codigo')?.invalid && productoForm.get('codigo')?.touched) {
            <p class="text-red-500 text-xs mt-1">
              @if (productoForm.get('codigo')?.hasError('required')) {
                El código es requerido
              }
              @if (productoForm.get('codigo')?.hasError('minlength')) {
                Mínimo 3 caracteres
              }
            </p>
          }
        </div>

        <!-- Nombre -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Nombre <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            formControlName="nombre"
            placeholder="Ej: Arroz Superior"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched"
          />
          @if (productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched) {
            <p class="text-red-500 text-xs mt-1">
              @if (productoForm.get('nombre')?.hasError('required')) {
                El nombre es requerido
              }
              @if (productoForm.get('nombre')?.hasError('minlength')) {
                Mínimo 3 caracteres
              }
            </p>
          }
        </div>

        <!-- Categoría -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Categoría <span class="text-red-500">*</span>
          </label>
          <select
            formControlName="categoria"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('categoria')?.invalid && productoForm.get('categoria')?.touched"
          >
            <option value="">Seleccione categoría</option>
            @for (cat of categorias; track cat) {
              <option [value]="cat">{{ cat }}</option>
            }
          </select>
          @if (productoForm.get('categoria')?.invalid && productoForm.get('categoria')?.touched) {
            <p class="text-red-500 text-xs mt-1">Seleccione una categoría</p>
          }
        </div>

        <!-- Precio -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Precio (S/) <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            step="0.01"
            formControlName="precio"
            placeholder="0.00"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('precio')?.invalid && productoForm.get('precio')?.touched"
          />
          @if (productoForm.get('precio')?.invalid && productoForm.get('precio')?.touched) {
            <p class="text-red-500 text-xs mt-1">
              @if (productoForm.get('precio')?.hasError('required')) {
                El precio es requerido
              }
              @if (productoForm.get('precio')?.hasError('min')) {
                El precio debe ser mayor a 0
              }
            </p>
          }
        </div>

        <!-- Stock Actual -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Stock Actual <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            formControlName="stock"
            placeholder="0"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched"
          />
          @if (productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched) {
            <p class="text-red-500 text-xs mt-1">El stock es requerido</p>
          }
        </div>

        <!-- Stock Mínimo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Stock Mínimo <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            formControlName="stockMinimo"
            placeholder="0"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('stockMinimo')?.invalid && productoForm.get('stockMinimo')?.touched"
          />
          @if (productoForm.get('stockMinimo')?.invalid && productoForm.get('stockMinimo')?.touched) {
            <p class="text-red-500 text-xs mt-1">
              @if (productoForm.get('stockMinimo')?.hasError('required')) {
                El stock mínimo es requerido
              }
              @if (productoForm.get('stockMinimo')?.hasError('min')) {
                Debe ser al menos 1
              }
            </p>
          }
        </div>

        <!-- Ubicación -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Ubicación en Almacén <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            formControlName="ubicacion"
            placeholder="Ej: A-01-01"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
            [class.border-red-500]="productoForm.get('ubicacion')?.invalid && productoForm.get('ubicacion')?.touched"
          />
          @if (productoForm.get('ubicacion')?.invalid && productoForm.get('ubicacion')?.touched) {
            <p class="text-red-500 text-xs mt-1">La ubicación es requerida</p>
          }
          <p class="text-xs text-gray-500 mt-1">Formato: Zona-Estante-Nivel (Ej: A-01-01)</p>
        </div>

        <!-- Estado -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Estado <span class="text-red-500">*</span>
          </label>
          <select
            formControlName="estado"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
          </select>
        </div>

        <!-- Proveedor -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Proveedor (Opcional)
          </label>
          <input
            type="text"
            formControlName="proveedor"
            placeholder="Nombre del proveedor"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
          />
        </div>

        <!-- Fecha de Vencimiento -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Fecha de Vencimiento (Opcional)
          </label>
          <input
            type="date"
            formControlName="fechaVencimiento"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500"
          />
          <p class="text-xs text-gray-500 mt-1">Solo para productos perecederos</p>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex justify-end gap-3 pt-6 mt-6 border-t border-gray-200">
        <button
          type="button"
          (click)="close()"
          class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
          [disabled]="isSubmitting()"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-6 py-2 bg-sky-900 text-white rounded-md hover:bg-sky-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          [disabled]="isSubmitting() || productoForm.invalid"
        >
          @if (isSubmitting()) {
            <span>Guardando...</span>
          } @else {
            <span>{{ producto ? 'Actualizar' : 'Crear Producto' }}</span>
          }
        </button>
      </div>

      <!-- Resumen de validación -->
      @if (productoForm.invalid && productoForm.touched) {
        <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
          <p class="text-sm text-red-800">
            <strong>Por favor complete todos los campos requeridos correctamente</strong>
          </p>
        </div>
      }
    </form>
  </div>
</div>
